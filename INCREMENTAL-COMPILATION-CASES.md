# LaTeX Incremental Compilation Cases

## LaTeX Compilation Pipeline Background

### Full Bibliography Pipeline (Baseline)
```
1. pdflatex  ‚Üí Generates .aux file with citation keys
2. bibtex    ‚Üí Reads .aux, processes .bib, generates .bbl
3. pdflatex  ‚Üí Reads .bbl, incorporates bibliography
4. pdflatex  ‚Üí Resolves cross-references (if needed)
```

### Key Files Produced
- `.aux` - Auxiliary file with citation keys, cross-references, labels
- `.bbl` - Bibliography file generated by bibtex from .bib + .aux
- `.toc`, `.lof`, `.lot` - Table of contents, list of figures/tables
- `.pdf` - Final output

---

## Incremental Compilation Cases

### Case 1: Only .tex files changed (NO .bib, NO assets)
**Example**: Editing body text, adding paragraphs, changing equations

**What's Valid from Cache:**
- ‚úÖ `.bbl` file (bibliography hasn't changed)
- ‚úÖ `.aux` file structure (may need update for cross-refs)

**Optimal Strategy:**
```
1. pdflatex  ‚Üí Update content, reuse .bbl
2. pdflatex  ‚Üí Resolve any cross-references (if needed)
```

**Savings**: Skip bibtex entirely! (2 passes instead of 4)

**Current Implementation**:
```go
if fileChanges.HasTexChanges && !fileChanges.HasBibChanges && !fileChanges.HasAssetChanges {
    needsBib = false  // ‚úÖ Skip bibtex
    // Keep needsMultiPass as-is  // ‚úÖ Still resolve cross-refs if detected
}
```

---

### Case 2: Only .bib files changed (NO .tex, NO assets)
**Example**: Adding a new reference, updating citation metadata

**What's Valid from Cache:**
- ‚úÖ `.aux` file (citation keys haven't changed)
- ‚ùå `.bbl` file (needs regeneration from new .bib)

**Optimal Strategy:**
```
1. bibtex    ‚Üí Regenerate .bbl from existing .aux + new .bib
2. pdflatex  ‚Üí Incorporate new bibliography
3. pdflatex  ‚Üí Resolve cross-references (if needed)
```

**Savings**: Skip first pdflatex! (3 passes instead of 4)

**Current Implementation**:
```go
else if !fileChanges.HasTexChanges && fileChanges.HasBibChanges {
    needsBib = true  // ‚úÖ Run bibtex
    // TODO: Should skip first pdflatex pass!
}
```

**‚ö†Ô∏è ISSUE**: Not yet optimized! Still runs full 4-pass pipeline.

---

### Case 3: Only assets changed (NO .tex, NO .bib)
**Example**: Updated image file, replaced PDF figure

**What's Valid from Cache:**
- ‚úÖ `.bbl` file
- ‚úÖ `.aux` file
- ‚úÖ All text content

**Optimal Strategy:**
```
1. pdflatex  ‚Üí Reload images, regenerate PDF
```

**Savings**: Single pass, no bibtex, no multipass! (1 pass instead of 4)

**Current Implementation**:
```go
else if !fileChanges.HasTexChanges && !fileChanges.HasBibChanges && fileChanges.HasAssetChanges {
    needsBib = false      // ‚úÖ Skip bibtex
    needsMultiPass = false // ‚úÖ Single pass
}
```

---

### Case 4: .tex + .bib both changed
**Example**: Added citation in text AND added reference to .bib

**What's Invalid:**
- ‚ùå `.aux` file (new citation keys)
- ‚ùå `.bbl` file (needs regeneration)

**Optimal Strategy:**
```
Full pipeline - no shortcuts available
1. pdflatex
2. bibtex
3. pdflatex
4. pdflatex
```

**Current Implementation**:
```go
// Falls through - no optimization
// needsBib and needsMultiPass keep their detected values
```
‚úÖ Correct!

---

### Case 5: .tex + assets both changed
**Example**: Updated text AND replaced an image

**What's Valid:**
- ‚úÖ `.bbl` file (bibliography unchanged)

**Optimal Strategy:**
```
1. pdflatex  ‚Üí Update text + reload images
2. pdflatex  ‚Üí Resolve cross-references (if needed)
```

**Savings**: Skip bibtex! (2 passes instead of 4)

**Current Implementation**:
```go
// Falls through - no optimization
// Would run full pipeline if bibliography detected in document
```

**‚ö†Ô∏è ISSUE**: Should skip bibtex but doesn't!

---

### Case 6: .bib + assets both changed
**Example**: Updated reference AND replaced figure

**What's Valid:**
- ‚úÖ `.aux` file (citation keys unchanged)

**Optimal Strategy:**
```
1. bibtex    ‚Üí Regenerate .bbl
2. pdflatex  ‚Üí Incorporate bibliography + reload images
3. pdflatex  ‚Üí Resolve cross-references
```

**Current Implementation**:
```go
// Falls through - runs full 4-pass pipeline
```

**‚ö†Ô∏è ISSUE**: Should skip first pdflatex but doesn't!

---

### Case 7: All three changed (.tex + .bib + assets)
**Example**: Major edit touching everything

**Optimal Strategy:**
```
Full pipeline - no shortcuts available
```

**Current Implementation**: ‚úÖ Correct!

---

### Case 8: No changes (identical content)
**Example**: Re-compile without any edits

**Optimal Strategy:**
```
Return cached PDF immediately (< 50ms)
```

**Current Implementation**: ‚úÖ Works! Content hash check returns instantly.

---

## Recommended Optimizations

### Priority 1: Fix Case 2 (Only .bib changed)
Skip first pdflatex when only bibliography changed:

```go
else if !fileChanges.HasTexChanges && fileChanges.HasBibChanges {
    log.Printf("[%s] INCREMENTAL: Only .bib changed, skip first pdflatex", c.RequestID)
    needsBib = true
    // Skip first pdflatex - start directly with bibtex
    // Need to add a new pipeline branch for this
}
```

### Priority 2: Fix Case 5 (.tex + assets)
Skip bibtex when bibliography files unchanged:

```go
if fileChanges.HasTexChanges && !fileChanges.HasBibChanges {
    log.Printf("[%s] INCREMENTAL: .tex changed but .bib unchanged, skip bibtex", c.RequestID)
    needsBib = false
    // assets don't affect this decision
}
```

### Priority 3: Fix Case 6 (.bib + assets)
Skip first pdflatex when only bibliography and assets changed:

```go
else if !fileChanges.HasTexChanges && fileChanges.HasBibChanges {
    log.Printf("[%s] INCREMENTAL: .bib/assets changed, skip first pdflatex", c.RequestID)
    needsBib = true
    // Start with bibtex
}
```

---

## Decision Matrix

| .tex | .bib | assets | Strategy | Passes | Current |
|------|------|--------|----------|--------|---------|
| ‚úì | ‚úó | ‚úó | Skip bibtex | 1-2 | ‚úÖ GOOD |
| ‚úó | ‚úì | ‚úó | Skip 1st pdflatex | 3 | ‚ùå NEEDS FIX |
| ‚úó | ‚úó | ‚úì | Single pass | 1 | ‚úÖ GOOD |
| ‚úì | ‚úì | ‚úó | Full pipeline | 4 | ‚úÖ GOOD |
| ‚úì | ‚úó | ‚úì | Skip bibtex | 1-2 | ‚ùå NEEDS FIX |
| ‚úó | ‚úì | ‚úì | Skip 1st pdflatex | 3 | ‚ùå NEEDS FIX |
| ‚úì | ‚úì | ‚úì | Full pipeline | 4 | ‚úÖ GOOD |
| ‚úó | ‚úó | ‚úó | Cache hit | 0 | ‚úÖ GOOD |

---

## Most Common Cases (Real-World Usage)

1. **Text editing** (.tex only): 60-70% of compilations
2. **Cache hit** (no changes): 20-30% of compilations  
3. **Multiple changes**: 5-10% of compilations
4. **Only .bib**: <5% of compilations
5. **Only assets**: <5% of compilations

**Conclusion**: Case 1 (text-only) is the critical path! Our current fix addresses this. üéØ

